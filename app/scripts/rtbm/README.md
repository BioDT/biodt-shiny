# RTBM Data Update Scripts

This directory contains scripts related to updating the data used by the Real-time Bird Monitoring (RTBM) pDT.

## `update_rtbm_parquet_data.R`

**Purpose:**

This script fetches the latest raw RTBM data (TIFF files) from the source bucket, caches them, and converts them into the partitioned Parquet format required by the Shiny application. It is designed to be run periodically (e.g., daily) by an external scheduler like cron, managed by the LifeWatch ERIC infrastructure.

**Operation:**

1.  Reads configuration (expects `data_path` to be defined in `config.yml` accessible from the execution environment).
2.  Determines the cache path (`[data_path]/rtbm/cache`) and Parquet output path (`[data_path]/rtbm/parquet`).
3.  Lists available TIFF files from the source URL (`https://2007581-webportal.a3s.fi/`).
4.  Downloads new or updated TIFF files into the cache path.
5.  Iterates through cached TIFF files:
    *   Parses the species name and date from the filename (assumes `Scientific_Name_YYYYMMDD.tif` format).
    *   Converts the TIFF data (non-NA values) into a dataframe (`x`, `y`, `value`, `date`).
    *   Writes the dataframe to a Parquet file within a partitioned directory structure: `[data_path]/rtbm/parquet/species=[Species_Name]/date=[YYYY-MM-DD].parquet`.
6.  Logs progress and summary information to standard output.

**Prerequisites:**

The environment running this script must have the following R packages installed:
*   `httr2`
*   `stringr`
*   `fs`
*   `config`
*   `purrr`
*   `terra`
*   `arrow`
*   `lubridate`
*   `(Optional) logger`

The `config.yml` file defining `data_path` must be accessible.

**Usage:**

```bash
Rscript app/scripts/rtbm/update_rtbm_parquet_data.R
```

You can modify the `force_update` arguments within the script's main execution block if you need to force re-downloading or re-conversion.

**Note on Filename Pattern:**

The script currently assumes TIFF filenames are in the format `Scientific_Name_YYYYMMDD.tif` (e.g., `Parus_major_20231026.tif`). If the actual format differs, the regex pattern and parsing logic within the `convert_tiffs_to_parquet` function must be updated accordingly.

## `clean_rtbm_parquet_data.R`

**Purpose:**

This script cleans the partitioned Parquet files generated by `update_rtbm_parquet_data.R`. It is designed to run *after* the update script (potentially in the same scheduled job) to ensure data integrity.

**Operation:**

1.  Reads configuration (expects `data_path`).
2.  Locates the RTBM Parquet data directory (`[data_path]/rtbm/parquet`).
3.  Iterates through each species directory and the Parquet files within.
4.  For each Parquet file, it performs checks:
    *   Can the file be read by `arrow`?
    *   Does the file contain any rows?
    *   Does the file contain the required columns (`longitude`, `latitude`, `intensity`, `date`)?
    *   Does the file contain any valid (non-NA, positive) `intensity` values?
5.  If any check fails, the invalid Parquet file is removed.
6.  After processing all files in a species directory, if the directory becomes empty, it is removed.
7.  Logs progress and summary information (files checked, files removed, directories removed) to standard output.

**Prerequisites:**

The environment running this script must have the following R packages installed:
*   `arrow`
*   `fs`
*   `config`
*   `purrr`

The `config.yml` file defining `data_path` must be accessible.

**Usage:**

```bash
Rscript app/scripts/rtbm/clean_rtbm_parquet_data.R
